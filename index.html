<!DOCTYPE html>
<html>
   <head>
      <title>Pool - by Devin Gray</title>
      <script src="mathlib-min.js"></script>
      <script>
window.addEventListener('load', onloadHandler, false);

var WHITE = "rgb(255,255,255)";
var YELLOW = "rgb(238,172,78)";
var BLUE = "rgb(0, 0, 153)";
var RED = "rgb(255,0,0)";
var PURPLE = "rgb(102, 0, 204)";
var ORANGE = "rgb(255, 102, 0)";
var GREEN = "rgb(0, 102, 0)";
var MAROON = "rgb(128, 0, 0)";
var BLACK = "rgb(0,0,0)";

var CUE = 0;
var SOLID = 1;
var STRIPE = 2;

var X_MAX = 1120; 
var Y_MAX = 640; 

//all the balls on the table
var ballList;

function shoot() {
    var x = document.getElementById('cue_x').value; 
    var y = document.getElementById('cue_y').value; 
    var velocity = document.getElementById('cue_velocity').value; 
    var cue_ball = ballList.balls[0];
    cue_ball.velocity.x = x * velocity;
    cue_ball.velocity.y = y * velocity;
    ballList.balls[0] = cue_ball;
}

function colliding(b1, b2) {
    //compare if this ball "hits" the other
    var ball1 = ballList.balls[b1];
    var ball2 = ballList.balls[b2];

    var dx = ball1.position.x - ball2.position.x;
    var dy = ball1.position.y - ball2.position.y;
    var distance = Math.sqrt(dx * dx + dy * dy);

    if (distance < ball1.radius + ball1.radius) {
        console.log('collision');
	return true;
    }
    return false;
}

function resolveCollision(b1, b2) {
    var ball1 = ballList.balls[b1];
    var ball2 = ballList.balls[b2];

/*
    // get the mtd
    //Vector2d delta = (position.subtract(ball.position));
    var delta = ball1.position.sub(ball2.position);
    console.log("delta:");
    console.log(delta);

    float d = delta.getLength();
    // minimum translation distance to push balls apart after intersecting
    Vector2d mtd = delta.multiply(((getRadius() + ball.getRadius())-d)/d); 


    // resolve intersection --
    // inverse mass quantities
    float im1 = 1 / getMass(); 
    float im2 = 1 / ball.getMass();

    // push-pull them apart based off their mass
    position = position.add(mtd.multiply(im1 / (im1 + im2)));
    ball.position = ball.position.subtract(mtd.multiply(im2 / (im1 + im2)));

    // impact speed
    Vector2d v = (this.velocity.subtract(ball.velocity));
    float vn = v.dot(mtd.normalize());

    // sphere intersecting but moving away from each other already
    if (vn > 0.0f) return;

    // collision impulse
    float i = (-(1.0f + Constants.restitution) * vn) / (im1 + im2);
    Vector2d impulse = mtd.multiply(i);

    // change in momentum
    this.velocity = this.velocity.add(impulse.multiply(im1));
    ball.velocity = ball.velocity.subtract(impulse.multiply(im2));
*/
}

function onloadHandler()
{
   // get the canvas DOM element
   var canvas = document.getElementById('canvas'),
       ctx = canvas.getContext("2d"),
       width = canvas.width,
       height = canvas.height;
   
   // data structures - generate initial balls
   ballList = new BallList();
   ballList.balls = getRack();

   function getRack() {
       var radius = 20;
       var xFactor = 1.73205;
       var x = 800;
       var y = 320;

       return [
          new Ball(0, WHITE, CUE, 200, y,  radius),

          new Ball(1, YELLOW, SOLID, x, y,  radius),
	  /*

          new Ball(2, BLUE, SOLID, x+radius*xFactor, y-radius,  radius),
          new Ball(3, RED, SOLID, x+radius*xFactor, y+radius,  radius),

          new Ball(4, PURPLE, SOLID, x+2*radius*xFactor, y-radius*2,  radius),
          new Ball(8, BLACK, SOLID, x+2*radius*xFactor, y,  radius),
          new Ball(6, GREEN, STRIPE, x+2*radius*xFactor, y+radius*2,  radius),

          new Ball(7, MAROON, STRIPE, x+3*radius*xFactor, y-radius*3,  radius),
          new Ball(5, ORANGE, STRIPE, x+3*radius*xFactor, y+radius*3,  radius),
          new Ball(9, YELLOW, STRIPE, x+3*radius*xFactor, y-radius,  radius),
          new Ball(10, BLUE, STRIPE, x+3*radius*xFactor, y+radius,  radius),

          new Ball(11, RED, STRIPE, x+4*radius*xFactor, y-radius*4,  radius),
          new Ball(12, PURPLE, STRIPE, x+4*radius*xFactor, y-radius*2,  radius),
          new Ball(13, ORANGE, STRIPE, x+4*radius*xFactor, y,  radius),
          new Ball(14, GREEN, STRIPE, x+4*radius*xFactor, y+radius*2,  radius),
          new Ball(15, MAROON, STRIPE, x+4*radius*xFactor, y+radius*4,  radius),
	  */
       ];
    }

   function drawText(x, y, text, color)
   {
     ctx.fillStyle = color;
     ctx.fillText(text, x, y);
   };
   
   function drawDisc(x, y, rad, color)
   {
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(x, y, rad, 0, TWOPI, true);
      ctx.fill();
   };
   
   // event handlers
   var mouseMove = function(e)
   {
      ballList.mousex = e.clientX;
      ballList.mousey = e.clientY;
   };
   canvas.addEventListener("mousemove", mouseMove, false);
   
   var offsetx = 0, offsety = 0;
   
   // init main animation loop
   requestAnimFrame(loop);
   function loop()
   {
      // compute canvas offset within parent window including page view position
      var el = canvas;
      offsetx = offsety = 0;
      do
      {
         offsetx += el.offsetLeft;
         offsety += el.offsetTop;
      } while (el = el.offsetParent);
      offsetx = offsetx - window.pageXOffset;
      offsety = offsety - window.pageYOffset;
      
      ctx.save();

      // clear the left side of the card
      // the right hand side is already rendered with fixed text
      ctx.clearRect(0, 0, width, height);
      
      // perform initial one time rendering of text etc.
      ctx.save();
      ctx.font = "Bold 40pt Arial";
      drawText(320,080,"Pool - by Devin Gray", WHITE);
      ctx.restore();
      
      // render each edge ball - which react to mouse movement
      ctx.globalCompositeOperation = 'darker';
      ballList.update();
      ballList.render();
      
      ctx.restore();
      
      requestAnimFrame(loop);
   };
   
   // data structures
   function BallList()
   {
      this.mousex = this.mousey = 0;
      this.balls = [];
      
      this.update = function()
      {
	 //collison detection

	 //first check bumpers
         for (var i = 0; i < this.balls.length; i++)
         {
            ball = this.balls[i];

	    if(ball.position.x > X_MAX-ball.radius || ball.position.x < 0+ball.radius) {
                ball.velocity.x *= -1;
	    }
	    if(ball.position.y > Y_MAX-ball.radius || ball.position.y < 0+ball.radius) {
                ball.velocity.y *= -1;
	    }
            
            ball.update();
         }

	 //now check balls
         for (var b1 = 0; b1 < this.balls.length; b1++)
         {
             for (var b2 = b1 + 1; b2 < this.balls.length; b2++)
             {
                 if(colliding(b1, b2)) {
		     resolveCollision(b1, b2);
		 }
             }
         }
      };
      
      this.render = function()
      {
         for (var i = 0; i < this.balls.length; i++)
         {
            ctx.save();
            this.balls[i].render();
            ctx.restore();
         }
      };
   };
   
   function Ball(num, color, type, x, y, radius)
   {
      this.num = num;
      this.color = color;
      this.type = type;
      this.origin = new Vector(x,y);
      this.position = new Vector(x,y);
      this.radius = radius;
      this.velocity = new Vector(0,0);
      this.friction = 0.995;
      
      this.update = function()
      {
         this.velocity.x *= this.friction;
         this.position.x += this.velocity.x;
         
         this.velocity.y *= this.friction;
         this.position.y += this.velocity.y;
      };
      
      this.render = function()
      {
         ctx.fillStyle = this.color;
         ctx.beginPath();
         ctx.arc(this.position.x, this.position.y, this.radius, 0, TWOPI, true);
         ctx.fill();

         //draw inner circle
	 if(this.type != CUE) {
             ctx.fillStyle = WHITE;
             ctx.beginPath();
             ctx.arc(this.position.x, this.position.y, this.radius/2, 0, TWOPI, true);
             ctx.fill();
         }

	 //draw the stripe
	 if(this.type == STRIPE) {
             ctx.fillStyle = WHITE;
             ctx.beginPath();
             ctx.arc(this.position.x, this.position.y, this.radius, 1.5*PI-0.8, 1.5*PI+0.8, false);
             ctx.fill();
             ctx.beginPath();
             ctx.arc(this.position.x, this.position.y, this.radius, 0.5*PI-0.8, 0.5*PI+0.8, false);
             ctx.fill();
	 }
	 if(this.num == 6 || this.num == 9) {
             ctx.fillStyle = BLACK;
             ctx.beginPath();
             ctx.arc(this.position.x, this.position.y, this.radius/3, 0.5*PI-0.5, 0.5*PI+0.5, false);
             ctx.stroke();
	 }

         // draw the ball number text
	 if(this.type != CUE) {
             ctx.save();
	     var fontSize = this.radius / 2;
             ctx.font = "Bold " + fontSize + "pt Arial";
             var textFudge = this.num > 9 ? 2.9 : 1.3;
             drawText(this.position.x-textFudge*3,this.position.y+textFudge+3.1, this.num, BLACK);
             ctx.restore();
	 }

	 // draw cue ball's little red dots
	 if(this.type == CUE) {
             ctx.fillStyle = RED;
             ctx.beginPath();
             ctx.arc(this.position.x, this.position.y, this.radius/6, 0, TWOPI, true);
             ctx.fill();
	 }
      };
   };
}

// requestAnimFrame shim
window.requestAnimFrame = (function()
{
   return  window.requestAnimationFrame       || 
           window.webkitRequestAnimationFrame || 
           window.mozRequestAnimationFrame    || 
           window.oRequestAnimationFrame      || 
           window.msRequestAnimationFrame     || 
           function(callback, element)
           {
               window.setTimeout(callback, 1000 / 60);
           };
})();
      </script>
      <style>
.table-container
{
   text-align: center;
   margin-bottom: 1.2em;
}
#canvas
{
   border: 1px solid #aaa;
   background: #1D8348;
   -moz-box-shadow: 3px 3px 8px #222;
   -webkit-box-shadow: 3px 3px 8px #222;
   box-shadow: 3px 3px 8px #222;
}
a, a:visited, a:active, a:hover
{
   color: #fff;
   text-decoration: none;
}
a:hover
{
   text-decoration: underline;
}
      </style>
   </head>
   
   <body style="background-color: #aaa">
      <div class="table-container">
         <canvas id="canvas" width="1120" height="640"></canvas>
      </div>
      x: <input type="text" id="cue_x" value="10" /> 
      y: <input type="text" id="cue_y" value="10" /> 
      velocity: <input type="text" id="cue_velocity" value="2" /> 
      <input type="button" id="shoot" value="Shoot" onclick="shoot()" />
   </body>
</html>
