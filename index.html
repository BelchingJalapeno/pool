<!DOCTYPE html>
<html>
   <head>
      <title>Pool - by Devin Gray</title>
      <script src="mathlib-min.js"></script>
      <script>
window.addEventListener('load', onloadHandler, false);

var WHITE = "rgb(255,255,255)";
var YELLOW = "rgba(238,172,78,.75)";
var BLUE = "rgb(0, 0, 153)";
var RED = "rgba(226,74,63,.9)";
var PURPLE = "rgb(102, 0, 204)";
var ORANGE = "rgb(255, 102, 0)";
var GREEN = "rgb(0, 102, 0)";
var MAROON = "rgb(128, 0, 0)";
var BLACK = "rgba(0,0,0)";

function onloadHandler()
{
   // get the canvas DOM element
   var canvas = document.getElementById('canvas'),
       ctx = canvas.getContext("2d"),
       width = canvas.width,
       height = canvas.height;
   
   // data structures - generate initial balls
   var ballList = new BallList();
   ballList.balls = getRack();

   function getRack() {
       var radius = 20;
       var xFactor = 1.73205;
       var x = 800;
       var y = 320;

       return [
          new Ball(1, YELLOW, x, y,  0, radius),

          new Ball(2, BLUE, x+radius*xFactor, y-radius,  0, radius),
          new Ball(3, RED, x+radius*xFactor, y+radius,  0, radius),

          new Ball(4, PURPLE, x+2*radius*xFactor, y-radius*2,  0, radius),
          new Ball(8, BLACK, x+2*radius*xFactor, y,  0, radius),
          new Ball(6, GREEN, x+2*radius*xFactor, y+radius*2,  0, radius),

          new Ball(7, MAROON, x+3*radius*xFactor, y-radius*3,  0, radius),
          new Ball(5, ORANGE, x+3*radius*xFactor, y+radius*3,  0, radius),
          new Ball(9, YELLOW, x+3*radius*xFactor, y-radius,  0, radius),
          new Ball(10, BLUE, x+3*radius*xFactor, y+radius,  0, radius),

          new Ball(11, RED, x+4*radius*xFactor, y-radius*4,  0, radius),
          new Ball(12, PURPLE, x+4*radius*xFactor, y-radius*2,  0, radius),
          new Ball(13, ORANGE, x+4*radius*xFactor, y,  0, radius),
          new Ball(14, GREEN, x+4*radius*xFactor, y+radius*2,  0, radius),
          new Ball(15, MAROON, x+4*radius*xFactor, y+radius*4,  0, radius),
       ];
    }

   function drawText(x, y, text, color)
   {
     ctx.fillStyle = color;
     ctx.fillText(text, x, y);
   };
   
   function drawDisc(x, y, rad, color)
   {
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(x, y, rad, 0, TWOPI, true);
      ctx.fill();
   };
   
   // event handlers
   var mouseMove = function(e)
   {
      ballList.mousex = e.clientX;
      ballList.mousey = e.clientY;
   };
   canvas.addEventListener("mousemove", mouseMove, false);
   
   var offsetx = 0, offsety = 0;
   
   // init main animation loop
   requestAnimFrame(loop);
   function loop()
   {
      // compute canvas offset within parent window including page view position
      var el = canvas;
      offsetx = offsety = 0;
      do
      {
         offsetx += el.offsetLeft;
         offsety += el.offsetTop;
      } while (el = el.offsetParent);
      offsetx = offsetx - window.pageXOffset;
      offsety = offsety - window.pageYOffset;
      
      ctx.save();
      
      // clear the left side of the card
      // the right hand side is already rendered with fixed text
      ctx.clearRect(0, 0, width, height);
      
      // perform initial one time rendering of text etc.
      ctx.save();
      ctx.font = "Bold 40pt Arial";
      drawText(320,080,"Pool - by Devin Gray", WHITE);
      ctx.restore();
      
      // render each edge ball - which react to mouse movement
      ctx.globalCompositeOperation = 'darker';
      ballList.update();
      ballList.render();
      
      ctx.restore();
      
      requestAnimFrame(loop);
   };
   
   // data structures
   function BallList()
   {
      this.mousex = this.mousey = 0;
      this.balls = [];
      
      this.update = function()
      {
         // all the other balls can animate based on mouse interaction
         for (var i = 0,dx,dy,d; i < this.balls.length; i++)
         {
            ball = this.balls[i];
            
            // calculate offset from mouse position - apply canvas element offset
            dx = this.mousex - (ball.position.x + offsetx);
            dy = this.mousey - (ball.position.y + offsety);
            d = Sqrt(dx * dx + dy * dy);
            
            // if the mouse is within the radius of a blog - then nudge it out
            var rad = (ball.originradius > 16 ? ball.originradius : 16);
            if (d < rad)
            {
               ball.targetPos.x = ball.position.x - dx;
               ball.targetPos.y = ball.position.y - dy;
               ball.spring = 0.033;
            }
            // else based on a random chance, pulse the ball
            else if (Rnd() > 0.995)
            {
               ball.targetPos.x = ball.origin.x;
               ball.targetPos.y = ball.origin.y;
               ball.velocity.z += (Rnd()*0.30 - 0.15);
               ball.spring = 0.0125;
            }
            // else just animate towards the original position
            else
            {
               ball.targetPos.x = ball.origin.x;
               ball.targetPos.y = ball.origin.y;
               ball.spring = 0.05;
            }
            
            ball.update();
         }
      };
      
      this.render = function()
      {
         for (var i = 0; i < this.balls.length; i++)
         {
            ctx.save();
            this.balls[i].render();
            ctx.restore();
         }
      };
   };
   
   function Ball(num, color, x, y, z, radius)
   {
      this.num = num;
      this.origin = new Vector3D(x,y,z);
      this.position = new Vector3D(x,y,z);
      this.targetPos = new Vector3D(x,y,z);
      this.originradius = radius;
      this.radius = radius;
      this.velocity = new Vector3D(0,0,0);
      this.color = color;
      this.friction = 0.75;
      this.spring = 0.05;
      
      this.update = function()
      {
         this.velocity.x += (this.targetPos.x - this.position.x) * this.spring;
         this.velocity.x *= this.friction;
         this.position.x += this.velocity.x;
         
         this.velocity.y += (this.targetPos.y - this.position.y) * this.spring;
         this.velocity.y *= this.friction;
         this.position.y += this.velocity.y;
         
         var dox = this.origin.x - this.position.x,
             doy = this.origin.y - this.position.y,
             d = Sqrt(dox * dox + doy * doy);
         
         this.targetPos.z = d/150 + 1;
         this.velocity.z += (this.targetPos.z - this.position.z) * this.spring;
         this.velocity.z *= this.friction;
         this.position.z += this.velocity.z;
         
         this.radius = this.originradius * this.position.z;
         if (this.radius < 1) this.radius = 1;
      };
      
      this.render = function()
      {
         ctx.fillStyle = this.color;
         ctx.beginPath();
         ctx.arc(this.position.x, this.position.y, this.radius, 0, TWOPI, true);
         ctx.fill();
         // draw the ball number text
         ctx.save();
         ctx.font = "Bold 12pt Arial";
         var textFudge = this.num > 9 ? 2.6 : 1.6;
         drawText(this.position.x-textFudge*3,this.position.y+textFudge+2.1, this.num, WHITE);
         ctx.restore();
      };
   };
}

// requestAnimFrame shim
window.requestAnimFrame = (function()
{
   return  window.requestAnimationFrame       || 
           window.webkitRequestAnimationFrame || 
           window.mozRequestAnimationFrame    || 
           window.oRequestAnimationFrame      || 
           window.msRequestAnimationFrame     || 
           function(callback, element)
           {
               window.setTimeout(callback, 1000 / 60);
           };
})();
      </script>
      <style>
.table-container
{
   text-align: center;
   margin-bottom: 2.5em;
}
#canvas
{
   border: 1px solid #aaa;
   background: #1D8348;
   -moz-box-shadow: 3px 3px 8px #222;
   -webkit-box-shadow: 3px 3px 8px #222;
   box-shadow: 3px 3px 8px #222;
}
a, a:visited, a:active, a:hover
{
   color: #fff;
   text-decoration: none;
}
a:hover
{
   text-decoration: underline;
}
      </style>
   </head>
   
   <body style="background-color: #aaa">
      <div class="table-container">
         <canvas id="canvas" width="1120" height="640"></canvas>
      </div>
   </body>
</html>
